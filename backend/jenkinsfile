pipeline {
	agent any
        environment {
            registry = "arijegrissiaa246/achat"
            registryCredential = 'dockerhub_id'
            dockerImage = ''
        }
      
	stages {

        stage('maven'){
            steps{
                sh "mvn --version"
            }

        }
        stage('Compile'){
            steps {
                dir("backend"){
                    sh "mvn clean compile"
                }
            }
        }
		stage('Package'){
			steps {
                dir("backend") {
                    sh "mvn package -DskipTests=true"
				    archive 'target/*.jar'
                }
				
			}
		}
       stage('JUnit')
        {
			steps 
            {
          		      dir("backend") 
                      {
                 		 sh "mvn test"
		 		         
                      }
			}
		}
      
	/*	stage('sonarqube'){
			steps{
                dir("backend") {
				    withSonarQubeEnv(installationName: 'sonar'){
				    sh "mvn sonar:sonar"
				    }
                }
			}
		} */
     /*   stage('deploy'){
            steps{
                dir("backend") {
                    sh "mvn deploy"
                }
            }
        }*/
       stage('Docker image') 
        {
            steps 
            {
               dir("backend") 
               {
                 script{
                 dockerImage = docker.build(registry)
                 }
               }
            }
        }
      stage('Deploy to dockerhub')
       {
           steps{
              script {
                docker.withRegistry( '', registryCredential ) {
                dockerImage.push()
                }
                 }
               }
         }
   /*   stage('Cleaning up') {
            steps {
                sh "docker rmi $registry:$BUILD_NUMBER"
            }
        }*/
     stage ('Docker compose'){
             steps{

                script{
                    sh 'docker compose -f docker-compose.yml up -d'
                }
            }
         }
	}
 post{
     	   always{
           	  emailext to: "arije.grissiaa@esprit.tn",
           	  subject: "jenkins build:${currentBuild.currentResult}: ${env.JOB_NAME}",
           	  body: "${currentBuild.currentResult}: Job ${env.JOB_NAME}\nMore Info can be found here: ${env.BUILD_URL}"
		 
        }
    }

}
