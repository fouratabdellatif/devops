pipeline {
	agent any
        environment {
            registry = "arijegrissiaa246/achat"
            registryCredential = 'dockerhub_id'
            dockerImage = ''
        }
      
	stages {

        stage('maven'){
            steps{
                sh "mvn --version"
            }

        }
        stage('Compile'){
            steps {
                dir("backend"){
                    sh "mvn clean compile"
                }
            }
        }
		stage('Package'){
			steps {
                dir("backend") {
                    sh "mvn package -DskipTests=true"
				    archive 'target/*.jar'
                }
				
			}
		}
       stage('JUnit')
        {
			steps 
            {
          		      dir("backend") 
                      {
                 		 sh "mvn test"
		 		         
                      }
			}
		}
      
	/*	stage('sonarqube'){
			steps{
                dir("backend") {
				    withSonarQubeEnv(installationName: 'sonar'){
				    sh "mvn sonar:sonar"
				    }
                }
			}
		} */
     /*   stage('deploy'){
            steps{
                dir("backend") {
                    sh "mvn deploy"
                }
            }
        }*/
       stage('Docker image') 
        {
            steps 
            {
               dir("backend") 
               {
                 script{
                 dockerImage = docker.build(registry + ":$BUILD_NUMBER")
                 }
               }
            }
        }
      stage('Deploy our image')
       {
           steps{
              script {
                docker.withRegistry( '', registryCredential ) {
                dockerImage.push()
                }
                 }
               }
         }
      stage('Cleaning up') {
            steps {
                sh "docker rmi $registry:$BUILD_NUMBER"
            }
        }
	}
}
